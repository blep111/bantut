<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Debug Multi-Bot Manager</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body{font-family:Arial;background:#071427;color:#dff3ff;padding:18px;}
  .card{max-width:900px;margin:12px auto;background:#051226;padding:16px;border-radius:8px;}
  input,textarea,button,select{width:100%;padding:8px;margin:8px 0;border-radius:6px;border:none;}
  button.primary{background:#0ea5e9;color:#002a3a;padding:10px;border-radius:6px;cursor:pointer;}
  button.danger{background:#ef4444;color:white;padding:8px;border-radius:6px;cursor:pointer;}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:8px;border-bottom:1px solid #0b2a3a;text-align:left;}
  pre{background:#021426;padding:10px;border-radius:6px;overflow:auto;}
</style>
</head>
<body>
  <div class="card">
    <h2>Token Store & Live Multi-Bot (debuggable)</h2>

    <h3>1) Add Token (only your own accounts)</h3>
    <label>Token</label>
    <textarea id="newToken"></textarea>
    <label>Name (optional)</label>
    <input id="newName" placeholder="e.g. acc1"/>
    <button id="addTokenBtn" class="primary">Add Token</button>

    <h3>2) Stored Tokens</h3>
    <div id="tokensArea">Loading...</div>

    <h3>3) Token / Target Diagnostics</h3>
    <label>Pick token (for tests)</label>
    <select id="diagToken"></select>
    <div class="row">
      <button id="testTokenBtn" class="primary">Test Token</button>
    </div>
    <label>Target ID to check</label>
    <input id="diagTarget" placeholder="target id"/>
    <button id="checkTargetBtn" class="primary">Check Target (what posts are visible to this token)</button>

    <h3>4) Start Multi-Bot</h3>
    <label>Choose stored accounts (checkboxes above), Target ID</label>
    <input id="botTarget" placeholder="target id to monitor"/>
    <label>Reactions (comma separated)</label>
    <input id="botReactions" value="LIKE,LOVE,HAHA"/>
    <label>Comment</label>
    <input id="botComment" value="hi master"/>
    <div style="display:flex;gap:8px;">
      <button id="startBotBtn" class="primary">Start Bot</button>
      <button id="stopBotBtn" class="danger">Stop Bot</button>
      <button id="refreshStatusBtn" class="primary">Status</button>
      <button id="viewLogsBtn" class="primary">View Logs</button>
    </div>

    <h3>5) Output / Logs</h3>
    <pre id="output">Ready.</pre>
  </div>

<script>
async function api(path, opts) {
  const r = await fetch(path, opts);
  return r.json();
}

async function loadTokens() {
  const area = document.getElementById('tokensArea');
  area.innerHTML = 'Loading...';
  try {
    const j = await api('/api/tokens');
    if (!j.success) { area.textContent = 'Failed loading tokens'; return; }
    if (j.tokens.length === 0) {
      area.innerHTML = '<div>No tokens stored.</div>';
      document.getElementById('diagToken').innerHTML = '<option value="">-- none --</option>';
      return;
    }
    let html = '<table><thead><tr><th>Use</th><th>Name</th><th>Id</th><th>Created</th><th>Action</th></tr></thead><tbody>';
    j.tokens.forEach(t => {
      html += `<tr>
        <td><input type="checkbox" class="tokCheck" data-id="${t.id}"></td>
        <td>${escapeHtml(t.name)}</td>
        <td>${t.id}</td>
        <td>${t.createdAt}</td>
        <td><button class="delBtn" data-id="${t.id}">Remove</button></td>
      </tr>`;
    });
    html += '</tbody></table>';
    area.innerHTML = html;
    // populate diagToken select
    const sel = document.getElementById('diagToken');
    sel.innerHTML = '<option value="">-- select token --</option>';
    j.tokens.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id; opt.textContent = `${t.name} (${t.id})`;
      sel.appendChild(opt);
    });
    document.querySelectorAll('.delBtn').forEach(btn => {
      btn.onclick = async () => {
        if (!confirm('Remove token?')) return;
        const id = btn.getAttribute('data-id');
        await fetch('/api/tokens/' + encodeURIComponent(id), { method: 'DELETE' });
        loadTokens();
      };
    });
  } catch (err) {
    area.textContent = 'Error: ' + err.toString();
  }
}

document.getElementById('addTokenBtn').addEventListener('click', async () => {
  const token = document.getElementById('newToken').value.trim();
  const name = document.getElementById('newName').value.trim();
  if (!token) return Swal.fire('Error','Token required','error');
  const j = await api('/api/add-token', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, name })});
  if (j.success) {
    Swal.fire('Saved','Token stored locally (encrypted)','success');
    document.getElementById('newToken').value = '';
    document.getElementById('newName').value = '';
    loadTokens();
  } else {
    Swal.fire('Error', j.error || 'Failed', 'error');
  }
});

// test token
document.getElementById('testTokenBtn').addEventListener('click', async () => {
  const sel = document.getElementById('diagToken').value;
  if (!sel) return Swal.fire('Pick token','Select a token to test','error');
  // fetch token list and find enc token via /api/tokens? We don't expose tokens; instead start-bot can use them.
  // For testing, we will ask user to paste token when prompt appears (safer)
  const token = prompt('Paste the token you want to test (or Cancel to test stored token by copying it here):');
  if (!token) return;
  document.getElementById('output').textContent = 'Testing token...';
  const j = await api('/api/test-token', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token })});
  document.getElementById('output').textContent = JSON.stringify(j, null, 2);
});

// check target visibility with a token
document.getElementById('checkTargetBtn').addEventListener('click', async () => {
  const token = prompt('Paste a token to use for checking target visibility:');
  const target = document.getElementById('diagTarget').value.trim();
  if (!token || !target) return Swal.fire('Error','Token and target required','error');
  document.getElementById('output').textContent = 'Checking target...';
  const j = await api('/api/check-target', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, targetId: target })});
  document.getElementById('output').textContent = JSON.stringify(j, null, 2);
});

// start bot
document.getElementById('startBotBtn').addEventListener('click', async () => {
  const checked = Array.from(document.querySelectorAll('.tokCheck:checked')).map(cb => cb.getAttribute('data-id'));
  if (checked.length === 0) return Swal.fire('Error','Select stored accounts to use','error');
  const target = document.getElementById('botTarget').value.trim();
  if (!target) return Swal.fire('Error','Enter target id','error');
  const reactions = document.getElementById('botReactions').value.split(',').map(s=>s.trim()).filter(Boolean);
  if (reactions.length === 0) return Swal.fire('Error','Enter reactions','error');
  const comment = document.getElementById('botComment').value.trim();
  document.getElementById('output').textContent = 'Starting bot...';
  const j = await api('/api/start-bot', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tokenIds: checked, targetId: target, reactions, comment })});
  document.getElementById('output').textContent = JSON.stringify(j, null, 2);
  if (j.success) Swal.fire('Started', j.message, 'success');
});

// stop
document.getElementById('stopBotBtn').addEventListener('click', async () => {
  const t = document.getElementById('botTarget').value.trim();
  if (!t) return Swal.fire('Error','Enter target id','error');
  const j = await api('/api/stop-bot', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ targetId: t })});
  document.getElementById('output').textContent = JSON.stringify(j, null, 2);
  Swal.fire('Stopped', j.message, 'info');
});

// status & logs
document.getElementById('refreshStatusBtn').addEventListener('click', async () => {
  const j = await api('/api/status');
  document.getElementById('output').textContent = JSON.stringify(j, null, 2);
});
document.getElementById('viewLogsBtn').addEventListener('click', async () => {
  const j = await api('/api/logs');
  document.getElementById('output').textContent = JSON.stringify(j, null, 2);
});

loadTokens();
</script>
</body>
</html>